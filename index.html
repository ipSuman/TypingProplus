<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Typing Pro+</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --bg:#0f131a;
  --card:#171f2b;
  --text:#ffffff;
  --sub:#7fbfc0;
  --accent:#2fb9b3;
  --box-bg: #0b1016; 
  --box-text: #ffffff;
  --correct:#7CFF9B;
  --half:#FFE066;
  --wrong:#FF7C7C;
  --brown:#8b5a2b;
  --orange:#ff9f43;
  --purple:#8e44ad;
  --red-black:#360a0a;
  --shadow:rgba(0,0,0,0.6);
  --timer-red: #ff4757; 
}

.light {
  --bg:#eef7f7;
  --card:#ffffff;
  --text:#111111;
  --sub:#4a6f70;
  --accent:#2fb9b3;
  --box-bg: #e3eaeb; 
  --box-text: #111111;
  --shadow:rgba(0,0,0,0.15);
}

* { box-sizing:border-box; font-family:system-ui,Segoe UI,sans-serif; }

body {
  margin:0;
  min-height:100vh;
  background:var(--bg);
  display:flex;
  justify-content:center;
  align-items:center;
  color:var(--text);
  transition: background 0.3s, color 0.3s;
}

.container {
  width:98%;
  max-width:1000px;
  background:var(--card);
  padding:25px;
  border-radius:28px;
  box-shadow:0 30px 60px var(--shadow);
  position: relative;
}

.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom: 15px;
}

.title { font-size:1.8em; font-weight:700; color:var(--accent); }

.row {
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom: 12px;
  align-items: center; 
}

.switch-container {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.85em;
  color: var(--sub);
  font-weight: 600;
}

.switch {
  position:relative;
  width:44px;
  height:22px;
}
.switch input { opacity:0; width:0; height:0; }
.slider {
  position:absolute;
  inset:0;
  background:#555;
  transition:.3s;
  border-radius:999px;
  cursor: pointer;
}
.slider:before {
  content:"";
  position:absolute;
  height:16px;
  width:16px;
  left:3px;
  bottom:3px;
  background:white;
  transition:.3s;
  border-radius:50%;
}
input:checked + .slider { background:var(--accent); }
input:checked + .slider:before { transform:translateX(22px); }

button, select, input, textarea {
  border:none;
  border-radius:14px;
  padding:10px 14px;
  background: var(--box-bg);
  color: var(--box-text);
  outline:none;
}

.btn-pill {
  font-size: 0.8em;
  padding: 8px 14px;
  font-weight: 600;
  cursor: pointer;
}

.btn-brown { background:var(--brown); color:white;}
.btn-purple { background:var(--purple); color:white;}
.btn-orange { background:var(--orange); color:#111; }
.btn-redblack { background:var(--red-black); color:#ffcccc; padding: 6px 14px; }

#customText {
  width:100%;
  resize:none;
  height:65px;
  margin-bottom: 15px;
}

#time {
  font-size: 4rem;
  font-weight: 800;
  color: var(--timer-red);
  text-align: center;
  margin: 10px 0;
  line-height: 1;
}

/* 5 Lines Heights Preserved */
.text-box {
  background: var(--box-bg); 
  border-radius:22px;
  padding:20px;
  height: 8.5em; 
  overflow-y:auto;
  line-height:1.7;
  font-size:1.15em;
  margin-bottom: 15px;
}

.text-box span.correct { color:var(--correct); }
.text-box span.half { color:var(--half); }
.text-box span.wrong { color:var(--wrong); }

.light .text-box span.correct { color:#1b5e20; font-weight: 600; }
.light .text-box span.half { color:#917100; }
.light .text-box span.wrong { color:#b71c1c; }

.input {
  width:100%;
  padding:20px;
  border-radius:20px;
  height: 8.5em; 
  font-size: 1.1em;
  margin-bottom: 20px;
  resize: none;
}

/* 6-Box Stats Grid Preserved */
.stats {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(130px,1fr));
  gap:12px;
}
.stat {
  background: var(--box-bg); 
  border-radius:20px;
  padding:15px;
  text-align:center;
}
.stat h3 { margin:0; font-size:.75em; color:var(--sub); text-transform: uppercase; }
.stat p { margin:6px 0; font-size:1.5em; font-weight:bold; }

.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.modal-content {
  background:var(--card);
  padding:25px;
  border-radius:24px;
  width:95%;
  max-width:800px;
  max-height: 90vh;
  overflow-y: auto;
}

.footer-info {
  margin-top: 20px;
  text-align: center;
  font-size: 0.75em;
  color: var(--sub);
  opacity: 0.8;
}

.bksp-icon { font-size: 1.3em; color: var(--sub); }

#leaderboardTable, #modTable { width: 100%; border-collapse: collapse; margin: 15px 0; }
#leaderboardTable th, #leaderboardTable td, #modTable th, #modTable td { padding: 10px; text-align: left; border-bottom: 1px solid var(--sub); }
.chart-container { background: var(--box-bg); padding: 15px; border-radius: 20px; margin-top: 15px; }
.mod-action-btn { font-size: 0.7em; padding: 4px 8px; margin-right: 5px; }
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <div class="title">Typing Pro+</div>
    <div style="display: flex; gap: 8px; align-items: center;">
      <button id="modBtn" class="btn-redblack" style="display:none;" onclick="handleModPanelAccess()">Mod</button>
      <button class="btn-redblack" onclick="openLeaderboard()">Rank</button>
      <button class="btn-redblack" onclick="openHistory()">History</button>
      <div class="switch-container">
        <label class="switch">
          <input type="checkbox" onchange="toggleTheme()">
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </div>

  <div class="row">
    <input id="username" placeholder="Enter your name" style="flex: 1;" oninput="checkAdmin()">
    <select id="timeMode" onchange="resetTestState()">
      <option value="60">1 Minute</option>
      <option value="120">2 Minutes</option>
      <option value="300">5 Minutes</option>
      <option value="600">10 Minutes</option>
    </select>
  </div>

  <div class="row">
    <div class="switch-container">
        <span>Endless</span>
        <label class="switch">
            <input type="checkbox" id="endlessToggle" onchange="resetTestState()">
            <span class="slider"></span>
        </label>
    </div>
    <div class="switch-container">
        <span>Auto-Submit</span>
        <label class="switch">
            <input type="checkbox" id="autoSubmitToggle" checked>
            <span class="slider"></span>
        </label>
    </div>
    <div class="switch-container" style="margin-left: auto;">
        <span class="bksp-icon">âŒ«</span>
        <label class="switch">
            <input type="checkbox" checked onchange="toggleBackspace(this)">
            <span class="slider"></span>
        </label>
    </div>
  </div>

  <textarea id="customText" oninput="resetTestState()" placeholder="Paste or type your custom typing text here..."></textarea>

  <div class="row">
    <button class="btn-pill btn-brown" onclick="saveFavorite()">Save Favorite</button>
    <select id="selectionMenu" class="btn-pill btn-purple" onchange="handleSelectionChange()">
      <option value="">Select text</option>
      <option value="random">ðŸŽ² Random Text</option>
      <option value="quotes">ðŸ“œ Famous Quotes</option>
      <optgroup label="Approved Globally" id="approvedGroup"></optgroup>
      <optgroup label="Your Favorites" id="favGroup"></optgroup>
    </select>
    <button class="btn-pill btn-orange" onclick="openContribute()">Contribute</button>
  </div>

  <div id="time">01:00</div>

  <div id="text" class="text-box"></div>
  <textarea id="input" class="input" placeholder="Start typing to begin..." onfocus="checkInit()"></textarea>

  <div class="stats">
    <div class="stat"><h3>WPM</h3><p id="wpm">0</p></div>
    <div class="stat"><h3>Net Speed</h3><p id="net">0</p></div>
    <div class="stat"><h3>Accuracy</h3><p id="acc">100%</p></div>
    <div class="stat"><h3>Error Rate</h3><p id="errRate">0</p></div>
    <div class="stat"><h3>Backspaces</h3><p id="backCount">0</p></div>
    <div class="stat"><h3>Wrong</h3><p id="wrongCount">0</p></div>
  </div>

  <div class="footer-info">
    Last Updated: <span id="lastUpdated">Loading...</span>
  </div>

</div>

<div class="modal" id="modModal">
  <div class="modal-content" style="max-width: 850px;">
    <h2>Global Moderator Panel</h2>
    <div style="max-height: 400px; overflow-y: auto;">
        <table id="modTable">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Text Snippet</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="modList"></tbody>
        </table>
    </div>
    <br>
    <button class="btn-pill btn-purple" onclick="closeModPanel()">Close</button>
  </div>
</div>

<div class="modal" id="rankModal">
  <div class="modal-content">
    <h2>Global Leaderboard</h2>
    <table id="leaderboardTable">
      <thead><tr><th>Rank</th><th>User</th><th>Net Speed</th><th>Acc</th></tr></thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
    <h3>Your Progress History</h3>
    <div class="chart-container"><canvas id="performanceChart"></canvas></div>
    <br><button class="btn-pill btn-purple" onclick="closeLeaderboard()">Close</button>
  </div>
</div>

<div class="modal" id="contribModal">
  <div class="modal-content">
    <h2>Contribute Globally</h2>
    <div class="contrib-form">
      <textarea id="contribBody" placeholder="Share your favorite text..."></textarea>
      <div style="display:flex; gap:10px; justify-content: flex-end;">
        <button class="btn-pill btn-purple" onclick="closeContribute()">Cancel</button>
        <button class="btn-pill btn-orange" onclick="submitContribution()">Submit</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="historyModal">
  <div class="modal-content">
    <h2>Local History</h2>
    <div id="historyTable" style="max-height: 300px; overflow-y: auto;"></div>
    <br>
    <button class="btn-pill btn-brown" onclick="clearHistory()">Clear</button>
    <button class="btn-pill btn-purple" onclick="closeHistory()">Close</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCPvNSfaAX8wTLrbjwOEQWi-826UzlAnjo",
  authDomain: "typingtest-v3.firebaseapp.com",
  databaseURL: "https://typingtest-v3-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "typingtest-v3",
  storageBucket: "typingtest-v3.firebasestorage.app",
  messagingSenderId: "959187636432",
  appId: "1:959187636432:web:6e55f9c7ef0902c3a40ed5",
  measurementId: "G-5WXEEQLNB4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let myChart = null;
let globalApprovedTexts = {};

// GITHUB AUTO-UPDATE FETCH preserved
async function fetchLastUpdated() {
    try {
        const repo = "TypingProplus"; const user = "ipsuman";
        const response = await fetch(`https://api.github.com/repos/${user}/${repo}/commits?per_page=1`);
        const data = await response.json();
        if (data && data[0]) {
            const date = new Date(data[0].commit.committer.date);
            document.getElementById("lastUpdated").innerText = date.toLocaleDateString() + " " + date.toLocaleTimeString();
        }
    } catch (e) { document.getElementById("lastUpdated").innerText = "Not available"; }
}
fetchLastUpdated();

// --- NEW GLOBAL APPROVED SYNC ---
function syncApprovedTexts() {
    db.ref('approved_texts').on('value', (snapshot) => {
        const group = document.getElementById("approvedGroup");
        group.innerHTML = "";
        globalApprovedTexts = snapshot.val() || {};
        Object.keys(globalApprovedTexts).forEach((key) => {
            const o = document.createElement("option");
            o.value = "appr_" + key;
            o.textContent = "Global: " + globalApprovedTexts[key].text.substring(0, 20) + "...";
            group.appendChild(o);
        });
    });
}
syncApprovedTexts();

const randomTexts = ["Innovation is the ability to see change as an opportunity...", "Technology is best when it brings people together...", "Data science is about using data to answer questions..."];
const famousQuotes = ["To be, or not to be...", "May the Force be with you...", "Life is what happens when you're busy making other plans..."];

let textDisplay = document.getElementById("text"), input = document.getElementById("input"), timeDisplay = document.getElementById("time");
let wpmDisplay = document.getElementById("wpm"), netDisplay = document.getElementById("net"), accDisplay = document.getElementById("acc");
let errRateDisplay = document.getElementById("errRate"), backDisplay = document.getElementById("backCount"), wrongDisplay = document.getElementById("wrongCount");

let timer, initialTime, currentTime, isRunning = false, backspaceOn = true, backspaces = 0;
const favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
const savedResults = JSON.parse(localStorage.getItem("results") || "[]");

function handleSelectionChange() {
    const val = document.getElementById("selectionMenu").value;
    if (val === "random") {
        document.getElementById("customText").value = randomTexts[Math.floor(Math.random() * randomTexts.length)];
    } else if (val === "quotes") {
        let selected = []; let tempArr = [...famousQuotes];
        for(let i=0; i<Math.min(4, tempArr.length); i++) {
            let idx = Math.floor(Math.random() * tempArr.length);
            selected.push(tempArr.splice(idx, 1)[0]);
        }
        document.getElementById("customText").value = selected.join(" ");
    } else if (val.startsWith("appr_")) {
        const key = val.replace("appr_", "");
        document.getElementById("customText").value = globalApprovedTexts[key].text;
    } else if (val !== "") {
        document.getElementById("customText").value = favorites[val];
    }
    resetTestState();
}

function loadFavoritesMenu() {
  const group = document.getElementById("favGroup");
  group.innerHTML = '';
  favorites.forEach((t, i) => {
    const o = document.createElement("option"); o.value = i; o.textContent = "Favorite " + (i + 1); group.appendChild(o);
  });
}
loadFavoritesMenu();

function saveFavorite() {
  const txt = document.getElementById("customText").value.trim();
  if(txt) { favorites.push(txt); localStorage.setItem("favorites", JSON.stringify(favorites)); loadFavoritesMenu(); }
}

function loadText(text) {
  textDisplay.innerHTML="";
  let finalString = document.getElementById("endlessToggle").checked ? (text + " ").repeat(60).trim() : text;
  finalString.split(" ").forEach(word => { const span = document.createElement("span"); span.textContent = word + " "; textDisplay.appendChild(span); });
}

function resetTestState() {
  clearInterval(timer); isRunning = false;
  initialTime = parseInt(document.getElementById("timeMode").value);
  currentTime = initialTime;
  timeDisplay.innerText = `${Math.floor(currentTime/60).toString().padStart(2,'0')}:${(currentTime%60).toString().padStart(2,'0')}`;
  input.value=""; input.disabled=false; backspaces = 0;
  wpmDisplay.innerText="0"; netDisplay.innerText="0"; accDisplay.innerText="100%";
  errRateDisplay.innerText="0"; backDisplay.innerText="0"; wrongDisplay.innerText="0";
  const custom = document.getElementById("customText").value.trim();
  if(custom) loadText(custom); else textDisplay.innerHTML = "Select text to start.";
}

resetTestState();

input.addEventListener("keydown", e => { if(e.key === "Backspace") { if(!backspaceOn) e.preventDefault(); else { backspaces++; backDisplay.innerText = backspaces; } } });
input.addEventListener("input", () => { if (!isRunning && input.value.length > 0) startTimer(); handleTyping(); });

function startTimer() {
  isRunning = true;
  timer = setInterval(() => {
    if(currentTime > 0) { currentTime--; timeDisplay.innerText = `${Math.floor(currentTime/60).toString().padStart(2,'0')}:${(currentTime%60).toString().padStart(2,'0')}`; handleTyping(); } 
    else finishTest();
  }, 1000);
}

function handleTyping() {
  const typedWords = input.value.trim().split(/\s+/); const spans = [...textDisplay.querySelectorAll("span")];
  if(input.value.length === 0) return;
  let correctChars = 0, wrong = 0, half = 0, finished = false;
  spans.forEach((span, i) => {
    span.className = ""; const real = span.textContent.trim(); const typed = typedWords[i];
    if(!typed) return;
    if(typed === real) { span.className = "correct"; correctChars += real.length; if(i === spans.length - 1) finished = true; } 
    else if(real.startsWith(typed)) { span.className = "half"; half++; } else { span.className = "wrong"; wrong++; }
  });
  wrongDisplay.innerText = wrong; const mins = ((initialTime - currentTime) / 60) || 0.001;
  wpmDisplay.innerText = Math.round((input.value.length / 5) / mins);
  accDisplay.innerText = Math.round((correctChars / input.value.length) * 100) + "%";
  netDisplay.innerText = Math.max(0, Math.round(((input.value.length / 5) - ((wrong+half) * 5)) / mins));
  if(document.getElementById("autoSubmitToggle").checked && finished && typedWords.length === spans.length) finishTest();
}

function finishTest() {
  clearInterval(timer); isRunning = false; input.disabled = true;
  const name = document.getElementById("username").value || "Guest";
  const result = { user: name, net: parseInt(netDisplay.innerText), acc: accDisplay.innerText, time: new Date().toLocaleString() };
  savedResults.push(result); localStorage.setItem("results", JSON.stringify(savedResults));
  if(name !== "Guest" && name !== "Admin") { db.ref('leaderboard').push(result); }
}

function openLeaderboard() {
    document.getElementById("rankModal").style.display = "flex";
    const body = document.getElementById("leaderboardBody"); body.innerHTML = "Loading...";
    db.ref('leaderboard').orderByChild('net').limitToLast(10).once('value', snapshot => {
        body.innerHTML = ""; let data = []; snapshot.forEach(child => { data.push(child.val()); });
        data.reverse().forEach((d, i) => { body.innerHTML += `<tr><td>${i+1}</td><td>${d.user}</td><td>${d.net} WPM</td><td>${d.acc}</td></tr>`; });
    });
    initChart();
}

function initChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    if(myChart) myChart.destroy();
    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: savedResults.map((r, i) => i + 1),
            datasets: [{ label: 'Speed', data: savedResults.map(r => r.net), borderColor: '#2fb9b3', backgroundColor: 'rgba(47, 185, 179, 0.2)', tension: 0.3, fill: true }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });
}

// MODERATOR AND GLOBAL APPROVAL LOGIC
function checkAdmin() { document.getElementById("modBtn").style.display = (document.getElementById("username").value === "Admin") ? "block" : "none"; }

function handleModPanelAccess() { if (prompt("Admin Password:") === "password123") openModPanel(); }

function openModPanel() {
    const list = document.getElementById("modList");
    list.innerHTML = "Loading...";
    db.ref('contributions').once('value', (snap) => {
        list.innerHTML = "";
        snap.forEach((child) => {
            const k = child.key; const d = child.val();
            list.innerHTML += `
                <tr>
                    <td>${d.user}</td>
                    <td title="${d.text}">${d.text.substring(0, 30)}...</td>
                    <td>
                        <button class="btn-pill btn-brown mod-action-btn" onclick="useContrib('${k}')">Use</button>
                        <button class="btn-pill btn-orange mod-action-btn" onclick="approveContrib('${k}')">Approve</button>
                        <button class="btn-pill btn-redblack mod-action-btn" onclick="deleteContrib('${k}')">Del</button>
                    </td>
                </tr>`;
        });
    });
    document.getElementById("modModal").style.display = "flex";
}

function approveContrib(key) {
    db.ref('contributions/' + key).once('value', (snapshot) => {
        const data = snapshot.val();
        if(data) {
            db.ref('approved_texts').push(data).then(() => {
                db.ref('contributions/' + key).remove();
                alert("Text approved globally!");
                openModPanel();
            });
        }
    });
}

function deleteContrib(key) { if(confirm("Delete globally?")) db.ref('contributions/' + key).remove().then(() => openModPanel()); }
function useContrib(key) { db.ref('contributions/' + key).once('value', s => { document.getElementById("customText").value = s.val().text; resetTestState(); closeModPanel(); }); }
function closeModPanel() { document.getElementById("modModal").style.display = "none"; }
function openContribute() { document.getElementById("contribModal").style.display = "flex"; }
function closeContribute() { document.getElementById("contribModal").style.display = "none"; }
function submitContribution() {
    const text = document.getElementById("contribBody").value.trim();
    if(text) { db.ref('contributions').push({ user: document.getElementById("username").value || "Guest", text, date: new Date().toLocaleString() }).then(() => { alert("Shared!"); closeContribute(); }); }
}
function openHistory() { document.getElementById("historyModal").style.display = "flex"; const container = document.getElementById("historyTable"); container.innerHTML = savedResults.length ? "<table>" + savedResults.map(r => `<tr><td>${r.user}</td><td>${r.net}</td><td>${r.acc}</td></tr>`).join("") + "</table>" : "Empty."; }
function closeHistory() { document.getElementById("historyModal").style.display = "none"; }
function closeLeaderboard() { document.getElementById("rankModal").style.display = "none"; }
function clearHistory() { localStorage.setItem("results","[]"); savedResults.length=0; openHistory(); }
function toggleBackspace(el) { backspaceOn = el.checked; }
function toggleTheme() { document.body.classList.toggle("light"); }
function checkInit() {}
</script>
</body>
</html>
